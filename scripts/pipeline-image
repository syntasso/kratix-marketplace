#!/usr/bin/env bash

set -e


declare -a args=( "$@" )
for dir_name in configure-pipeline configure-promise-pipeline; do
  promise_name="$(basename "$(dirname "${PWD}")")"
  if [ "${PROMISE_NAME:-""}" != "" ]; then
    promise_name="${PROMISE_NAME}"
  fi
  pipeline_dir=${dir_name}
  if [ "${PIPELINE_DIR:-""}" != "" ]; then
    pipeline_dir="${PIPELINE_DIR}"
  fi
  pipeline_image="ghcr.io/syntasso/kratix-marketplace/${promise_name}-${dir_name}:v0.1.0"

  if [ -d "${PWD}/${pipeline_dir}" ]; then
    set -- "${args[@]}"
    while [ $# -gt 0 ]; do
      case "$1" in
        build)
          docker build \
            --tag "${pipeline_image}" \
            --platform linux/$(uname -m) \
            "${PWD}/${pipeline_dir}" ;;

        load)
          kind load docker-image "${pipeline_image}" --name platform ;;

        push)
          if ! docker buildx ls | grep -q "kratix-image-builder"; then \
          	docker buildx create --name kratix-image-builder; \
          fi;
          docker buildx build \
            --builder kratix-image-builder \
            --tag "${pipeline_image}" \
            --platform linux/arm64,linux/amd64 \
            --push \
            "${PWD}/${pipeline_dir}" ;;

        rmi)
          docker rmi --force "${pipeline_image}" ;;

        pull)
          docker pull "${pipeline_image}" ;;

        *)
          echo "unknown command $1"
          exit 1
          ;;
      esac
      shift
    done
  fi
done
